AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM config for Tweeter server

#
# Global Lambda function properties. These apply to every Lambda function.
#
Globals:
  Function:
    Runtime: nodejs20.x
    CodeUri: ./dist/
    Layers:
      - !Ref tweeterLayer
    Timeout: 30
    MemorySize: 128

#
# Reusable blocks of configuration. These are referenced throughout the template to avoid duplication.
# &identifier is used to define a reusable block, and *identifier is used to reference it.
#
Metadata:
  x-common-policies: &commonPolicies
    - AWSLambdaBasicExecutionRole
    - AmazonSESFullAccess
    - CloudWatchFullAccess
    - AmazonDynamoDBFullAccess
    - AmazonS3FullAccess
    - AmazonSQSFullAccess

  x-common-cors-headers: &commonCorsHeaders
    method.response.header.Access-Control-Allow-Origin: "'*'"

  x-common-swagger-response-headers: &commonSwaggerResponseHeaders
    Access-Control-Allow-Origin:
      type: string

#
# AWS resource definitions
#
Resources:
  #
  # Web API
  #
  tweeterApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: tweeterApi
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
      DefinitionBody:
        swagger: "2.0"
        info:
          title: "Tweeter API"
          version: "1.0"
        x-common-consumes: &commonConsumes
          - application/json
        x-common-produces: &commonProduces
          - application/json
        x-common-request-templates: &commonRequestTemplates
          application/json: $input.json('$')
        x-common-amazon-responses: &commonAmazonResponses
          default:
            statusCode: 200
            responseParameters: *commonCorsHeaders
          ".*bad-request.*":
            statusCode: 400
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*unauthorized.*":
            statusCode: 401
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*internal-server-error.*":
            statusCode: 500
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
        x-common-swagger-responses: &commonSwaggerResponses
          "200":
            description: "OK"
            headers: *commonSwaggerResponseHeaders
          "400":
            description: "Bad Request"
            headers: *commonSwaggerResponseHeaders
          "401":
            description: "Unauthorized"
            headers: *commonSwaggerResponseHeaders
          "500":
            description: "Internal Server Error"
            headers: *commonSwaggerResponseHeaders
        paths:
          #
          # Endpoint definitions
          #

          # Template for endpoints
          # /user/get: # Endpoint here
          #   post:
          #     consumes: *commonConsumes
          #     produces: *commonProduces
          #     x-amazon-apigateway-integration:
          #       type: aws
          #       httpMethod: POST
          #       uri:
          #         ##### Change "userGetFunction" to the actual function name.
          #         Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${userGetFunction.Arn}/invocations
          #       requestTemplates: *commonRequestTemplates
          #       responses: *commonAmazonResponses
          #     responses: *commonSwaggerResponses

          #
          # ADD MORE ENDPOINT DEFINITIONS HERE
          #

          /followees/get:
            post:
              description: "Retrieves the list of users that the authenticated user is following"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweesFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /followers/get:
            post:
              description: "Retrieves the list of users following the authenticated user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowersFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/get:
            post:
              description: "Retrieves user profile information"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUserFunction.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/followerstatus/get:
            post:
              description: "Checks if the authenticated user is following a specified user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetIsFollowerStatus.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/followerCount/get:
            post:
              description: "Retrieves the total number of followers for a user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetFollowerCount.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/followeeCount/get:
            post:
              description: "Retrieves the total number of users that a user is following"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetFolloweeCount.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/follow:
            post:
              description: "Follows a specified user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Follow.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/unfollow:
            post:
              description: "Unfollows a specified user"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Unfollow.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /auth/login:
            post:
              description: "Authenticates a user and creates a session"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Login.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /auth/logout:
            post:
              description: "Logs out the authenticated user and ends their session"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Logout.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /auth/register:
            post:
              description: "Registers a new user account"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Register.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/post:
            post:
              description: "Creates and posts a new status update"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PostStatus.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/loadmorefeeditems:
            post:
              description: "Loads additional feed items with pagination support"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LoadMoreFeedItems.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/loadmorestoryitems:
            post:
              description: "Loads additional story items for a user's profile with pagination support"
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LoadMoreStoryItems.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

  #
  # SQS Queues
  #

  #   MyQueue:
  #     Type: AWS::SQS::Queue
  #     Properties:
  #       QueueName: MyQueue

  #
  # Lambda Layer (reused by all Lambda functions)
  #
  tweeterLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: tweeterLayer
      Description: dependencies layer for Tweeter server
      ContentUri: ./layer/
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: DELETE

  #
  # Web API Lambda functions
  #

  # Template for functions
  # userCreateFunction:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     FunctionName: userCreateFunction
  #     ##### Modify Handler property to match your code.
  #     Handler: handlers/users/UserCreateHandler.userCreateHandler
  #     Policies: *commonPolicies
  #     Events:
  #       PostApi:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref tweeterApi
  #           Path: /user/create
  #           Method: POST

  getFolloweesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFolloweesFunction
      ##### Modify Handler property to match your code.
      Handler: lambda/follow/GetFolloweesLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /followees/get
            Method: POST # Keep all of them POST

  getFollowersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowersFunction
      ##### Modify Handler property to match your code.
      Handler: lambda/follow/GetFollowersLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /followers/get
            Method: POST # Keep all of them POST

  getUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getUserFunction
      ##### Modify Handler property to match your code.
      Handler: lambda/user/GetUserLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/get
            Method: POST # Keep all of them POST

  GetIsFollowerStatus:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetIsFollowerStatus
      ##### Modify Handler property to match your code.
      Handler: lambda/user/GetIsFollowerStatus.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/followerstatus/get
            Method: POST # Keep all of them POST

  GetFollowerCount:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetFollowerCount
      ##### Modify Handler property to match your code.
      Handler: lambda/user/GetFollowerCount.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/followerCount/get
            Method: POST # Keep all of them POST

  GetFolloweeCount:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetFolloweeCount
      ##### Modify Handler property to match your code.
      Handler: lambda/user/GetFolloweeCount.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/followeeCount/get
            Method: POST # Keep all of them POST

  Follow:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Follow
      ##### Modify Handler property to match your code.
      Handler: lambda/user/Follow.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/follow
            Method: POST # Keep all of them POST

  Unfollow:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Unfollow
      ##### Modify Handler property to match your code.
      Handler: lambda/user/Unfollow.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/unfollow
            Method: POST # Keep all of them POST

  Login:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Login
      ##### Modify Handler property to match your code.
      Handler: lambda/auth/LoginLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /auth/login
            Method: POST # Keep all of them POST

  Logout:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Logout
      ##### Modify Handler property to match your code.
      Handler: lambda/auth/LogoutLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /auth/logout
            Method: POST # Keep all of them POST

  Register:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: Register
      ##### Modify Handler property to match your code.
      Handler: lambda/auth/RegisterLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /auth/register
            Method: POST # Keep all of them POST

  PostStatus:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: PostStatus
      ##### Modify Handler property to match your code.
      Handler: lambda/status/PostStatusLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/post
            Method: POST # Keep all of them POST

  LoadMoreFeedItems:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: LoadMoreFeedItems
      ##### Modify Handler property to match your code.
      Handler: lambda/status/LoadMoreFeedItemsLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/loadmorefeeditems
            Method: POST # Keep all of them POST

  LoadMoreStoryItems:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: LoadMoreStoryItems
      ##### Modify Handler property to match your code.
      Handler: lambda/status/LoadMoreStoryItemsLambda.handler # Handler code here
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/loadmorestoryitems
            Method: POST # Keep all of them POST

  #
  # ADD MORE WEB API LAMBDA DEFINITIONS HERE
  #

  #
  # SQS Queue Lambda Functions
  #

  #   MyQueueFunction:
  #     Type: AWS::Serverless::Function
  #     Properties:
  #       FunctionName: MyQueueFunction
  #       Handler: <PATH TO LAMBDA HANDLER>
  #       Policies: *commonPolicies
  #       Events:
  #         SQSTrigger:
  #           Type: SQS
  #           Properties:
  #             Queue: !GetAtt MyQueue.Arn
  #             Enabled: true

  #
  # DynamoDB Tables
  #
  followTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: follow
      AttributeDefinitions:
        - AttributeName: follower_alias
          AttributeType: S
        - AttributeName: followee_alias
          AttributeType: S
      KeySchema:
        - AttributeName: follower_alias
          KeyType: HASH
        - AttributeName: followee_alias
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: follow_index
          KeySchema:
            - AttributeName: followee_alias
              KeyType: HASH
            - AttributeName: follower_alias
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  #
  # ADD MORE TABLE DEFINITIONS HERE
  #
